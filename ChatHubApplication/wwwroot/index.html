<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>SignalR Chat - Заколебал</title>
</head>
<body>
    <div id="loginBlock">
        Введите логин:<br />
        <input id="userName" type="text" />
        <input id="loginBtn" type="button" value="Войти" />
    </div><br />

    <div id="groupBlock">
        Введите название комнаты:<br />
        <input id="groupName" type="text" />
        <input id="enterGroupBtn" type="button" value="Войти в комнату" />
        <input id="exitGroupBtn" type="button" value="Выйти из комнаты" hidden/>
        <input id="readyBtn" type="button" value="Готов" hidden/>
    </div><br />

    <div id="header"></div><br />

    <div id="inputForm">
        <input type="text" id="message" />
        <input type="button" id="sendBtn" value="Отправить" />
    </div>
    <div id="chatroom"></div>
    <script src="js/signalr/dist/browser/signalr.min.js"></script>
    <script>
        const hubConnection = new signalR.HubConnectionBuilder()
            .withUrl("/chat")
            .build();

        let userName = '';
        let groupName = '';
        let readyState = false;
        let inGame = false;

        // получение сообщения от сервера (чат)
        hubConnection.on('Send', function (message, userName) {

            // создаем элемент <b> для имени пользователя
            let userNameElem = document.createElement("b");
            userNameElem.appendChild(document.createTextNode(userName + ': '));

            // создает элемент <p> для сообщения пользователя
            let elem = document.createElement("p");
            elem.appendChild(userNameElem);
            elem.appendChild(document.createTextNode(message));

            var firstElem = document.getElementById("chatroom").firstChild;
            document.getElementById("chatroom").insertBefore(elem, firstElem);

        });

        // событие входа в комнату
        hubConnection.on("RoomEnteredEvent", function () {
            var exitBtn = document.getElementById("exitGroupBtn");
            var readyBtn = document.getElementById("readyBtn");
            exitBtn.hidden = false;
            readyBtn.hidden = false;
        });

        // событие выхода из комнаты
        hubConnection.on("RoomExitedEvent", function () {
            var exitBtn = document.getElementById("exitGroupBtn");
            var readyBtn = document.getElementById("readyBtn");
            exitBtn.hidden = true;
            readyBtn.hidden = true;
        });

        // событие отработки нажатия готово
        hubConnection.on("ReadyStateUpdate", function (isReady) {
            readyState = isReady;
            var readyBtn = document.getElementById("readyBtn");

            if (readyState) {
                readyBtn.value = "Не готов"
            } else {
                readyBtn.value = "Готов"
            }
        });

        // событие для обновления счётчика готовых
        hubConnection.on("UpdateReadyCounter", function (roomUserCount, roomReadyCount) {
            userCount = roomUserCount;
            readyCount = roomReadyCount;
            var headerString = `Комната ${groupName} (${readyCount}/${userCount})`;
            document.getElementById("header").innerHTML = '<h3>' + headerString + '</h3>';
        });

        // событие для обновления хедера при начале игры
        hubConnection.on("UpdateGameHeader", function (guessingWord) {
            var headerString = `Комната ${groupName} (в игре): ${guessingWord}`;
            document.getElementById("header").innerHTML = '<h3>' + headerString + '</h3>';
        });

        // событие начала игры
        hubConnection.on("GameStart", function () {
            var senButton = document.getElementById("sendBtn");
            var readyBtn = document.getElementById("readyBtn");
            senButton.disabled = true;
            readyBtn.hidden = true;
            inGame = true;
        });

        // событие получения права на ход
        hubConnection.on("TurnEvent", function () {
            var senButton = document.getElementById("sendBtn");
            senButton.disabled = false;
        });

        // событие окончания хода
        hubConnection.on("TurnOverEvent", function () {
            var senButton = document.getElementById("sendBtn");
            senButton.disabled = true;
        });

        // событие начала игры
        hubConnection.on("GameOver", function () {
            var sendButton = document.getElementById("sendBtn");
            sendButton.disabled = false;
            readyBtn.hidden = false;
            readyBtn.value = "Не готов";
            inGame = false;
        });

        // установка имени пользователя
        document.getElementById("loginBtn").addEventListener("click", function (e) {
            userName = document.getElementById("userName").value;
            hubConnection.invoke("Authorize", userName);
        });

        // вход в группу
        document.getElementById("enterGroupBtn").addEventListener("click", function (e) {
            groupName = document.getElementById("groupName").value;
            hubConnection.invoke("AddToRoom", groupName, userName);
        });

        // выход из группы
        document.getElementById("exitGroupBtn").addEventListener("click", function (e) {
            hubConnection.invoke("RemoveFromRoom", userName);
        });

        // нажатие кнопки готов
        document.getElementById("readyBtn").addEventListener("click", function (e) {
            hubConnection.invoke("Ready", !readyState, userName);
        });

        // отправка сообщения на сервер
        document.getElementById("sendBtn").addEventListener("click", function (e) {
            let msg = document.getElementById("message");
            if (inGame) {
                hubConnection.invoke("TurnAttempt", msg.value, userName);
            } else {
                hubConnection.invoke("Send", msg.value, userName);
            }
            msg.value = "";
        });

        hubConnection.start();
    </script>
</body>
</html>